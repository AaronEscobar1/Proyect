<!-- Mensajes de alertas para usuarios -->
<p-toast></p-toast>
<p-confirmDialog ></p-confirmDialog>

<div class="mt-3">

    <form [formGroup]="form">
        <div formArrayName="procesos">
            
            <p-table [value]="procesosFormArray.controls" [columns]="columns" #dt
                     (sortFunction)="customSort($event)" [customSort]="true"
                     dataKey="controls.idTableTemporal.value" editMode="row"
                     [paginator]="true" [rows]="rows"
                     styleClass="p-datatable-scrollable" responsiveLayout="scroll"
                     [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} registros de {totalRecords} entradas." [rowsPerPageOptions]="[5, 10, 25, 50]">

                <ng-template pTemplate="caption">
                    <div class="grid flex-row-reverse">
                        <div class="col-12 md:col-4 lg:col-3">
                            <button pButton
                                    label="Agregar proceso" 
                                    class="p-button-secondary"
                                    (click)="addNewRow()"
                                    [disabled]="isEdit || isAddNewRow">
                            </button>
                        </div>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th *ngFor="let col of columns" [pSortableColumn]="col.field" class="text-center">
                            {{ col.header }}
                            <p-sortIcon [field]="col.field"></p-sortIcon>
                        </th>
                        <th style="width:8rem"></th>
                    </tr>
                    <!-- <tr>
                        <th *ngFor="let col of columns">
                            <p-columnFilter [field]="col.field" matchMode="contains" [showMenu]="false" [showClearButton]="false">
                                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                                    <input pInputText type="text" (input)="filter($any($event.target).value)" [placeholder]="'Buscar ' + col.header + '...'">
                                </ng-template>
                            </p-columnFilter>
                        </th>
                        <th></th>
                    </tr> -->
                </ng-template>

                <ng-template pTemplate="body" let-procesoSituacion let-editing="editing" let-index="rowIndex">
                    <tr [pEditableRow]="procesoSituacion" [formGroupName]="index">
                        <td>
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <input pInputText type="text" class="text-right" formControlName="procTippro">
                                    <span class="form-text text-danger" *ngIf="campoInvalid(procesoSituacion.controls['procTippro'])">
                                        <span *ngIf="procesoSituacion.controls['procTippro']?.errors?.required"> 
                                            El código es obligatorio. 
                                        </span>
                                        <div *ngIf="procesoSituacion.controls['procTippro']?.errors?.maxlength"> 
                                            El código es de longitud máxima de 2 dígitos. 
                                        </div>
                                    </span>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ procesoSituacion.getRawValue().procTippro }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td>
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <input pInputText type="text" class="text-right" formControlName="tipsub">
                                    <span class="form-text text-danger" *ngIf="campoInvalid(procesoSituacion.controls['tipsub'])">
                                        <span *ngIf="procesoSituacion.controls['tipsub']?.errors?.required"> 
                                            El Subproceso es obligatorio. 
                                        </span>
                                        <div *ngIf="procesoSituacion.controls['tipsub']?.errors?.pattern"> 
                                            El Subproceso es de longitud de 1 dígito, formato numérico. 
                                        </div>
                                    </span>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ procesoSituacion.getRawValue().tipsub }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td class="text-right">
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <input pInputText type="text" class="text-right" formControlName="dialim">
                                    <span class="form-text text-danger" *ngIf="campoInvalid(procesoSituacion.controls['dialim'])">
                                        <span *ngIf="procesoSituacion.controls['dialim']?.errors?.required"> 
                                            El campo día es obligatorio. 
                                        </span>
                                        <div *ngIf="procesoSituacion.controls['dialim']?.errors?.pattern"> 
                                            El campo día es de longitud máxima de 3 dígitos, formato numérico. 
                                        </div>
                                    </span>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ procesoSituacion.getRawValue().dialim }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td>
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <p-dropdown [options]="noSuspender" 
                                                appendTo="body"
                                                class="w-full"
                                                formControlName="susvac"
                                                optionLabel="descripcion"
                                                optionValue="susvac">
                                    </p-dropdown>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ procesoSituacion.getRawValue().susvac == 0 ? 'No aplica' :
                                        procesoSituacion.getRawValue().susvac == 1 ? 'Salida' : 'Regreso' }}   
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td class="text-center">
                            <button *ngIf="!editing" 
                                    pButton
                                    pInitEditableRow 
                                    icon="pi pi-pencil"
                                    class="p-button-rounded p-button-text"
                                    pTooltip="Editar"
                                    tooltipPosition="bottom"
                                    (click)="onRowEditInit(procesoSituacion);"
                                    [disabled]="isEdit || isAddNewRow">
                            </button>
                            <button *ngIf="!editing" 
                                    pButton
                                    icon="pi pi-trash"
                                    class="p-button-rounded p-button-text"
                                    pTooltip="Eliminar"
                                    tooltipPosition="bottom"
                                    (click)="onRowDelete(procesoSituacion.getRawValue())"
                                    [disabled]="isEdit || isAddNewRow">
                            </button>
                            <button *ngIf="editing" 
                                    pButton
                                    pSaveEditableRow 
                                    icon="pi pi-save"
                                    class="p-button-rounded p-button-text p-button-success mr-2"
                                    pTooltip="Guardar"
                                    tooltipPosition="bottom"
                                    (click)="onRowEditSave(procesoSituacion.getRawValue())"
                                    [disabled]="procesoSituacion.status == 'INVALID'">
                            </button>
                            <button *ngIf="editing" 
                                    pButton
                                    pCancelEditableRow 
                                    icon="pi pi-times"
                                    class="p-button-rounded p-button-text p-button-danger"
                                    pTooltip="Cancelar"
                                    tooltipPosition="bottom"
                                    (click)="onRowEditCancel(procesoSituacion, index)">
                            </button>
                        </td>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="emptymessage" let-columns>
                    <tr>
                        <td [attr.colspan]="columns.length + 1">
                            <div class="div-center">
                                <div>
                                    <div class="div-round"></div>
                                    <h5 class="no-data-message-1">Sin datos para mostrar</h5>
                                </div>
                            </div>
                        </td>
                    </tr>
                </ng-template>

            </p-table>

        </div>
    </form>

</div>
