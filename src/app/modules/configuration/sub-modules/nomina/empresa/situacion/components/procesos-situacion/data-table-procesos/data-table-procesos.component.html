<!-- Mensajes de alertas para usuarios -->
<p-toast></p-toast>
<p-confirmDialog ></p-confirmDialog>

<div class="mt-3">

    <form [formGroup]="form">
        <div formArrayName="procesos">
            
            <p-table [value]="procesosFormArray.controls" [columns]="columns" #dt
                     (sortFunction)="customSort($event)" [customSort]="true"
                     dataKey="controls.idTableTemporal.value" editMode="row"
                     [paginator]="true" [rows]="rows"
                     styleClass="p-datatable-scrollable" responsiveLayout="scroll"
                     [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} registros de {totalRecords} entradas." [rowsPerPageOptions]="[5, 10, 25, 50]">

                <ng-template pTemplate="caption">
                    <div class="grid flex-row-reverse">
                        <div class="col-12 md:col-4 lg:col-3">
                            <button pButton
                                    label="Agregar proceso" 
                                    class="p-button-secondary"
                                    (click)="addNewRow()"
                                    [disabled]="isEdit || isAddNewRow">
                            </button>
                        </div>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th colspan="2" [pSortableColumn]="columns[0].field"> {{ columns[0].header }} <p-sortIcon [field]="columns[0].field"></p-sortIcon></th>
                        <th [pSortableColumn]="columns[1].field"> {{ columns[1].header }} <p-sortIcon [field]="columns[1].field"></p-sortIcon></th>
                        <th [pSortableColumn]="columns[2].field"> {{ columns[2].header }} <p-sortIcon [field]="columns[2].field"></p-sortIcon></th>
                        <th [pSortableColumn]="columns[3].field"> {{ columns[3].header }} <p-sortIcon [field]="columns[3].field"></p-sortIcon></th>
                        <th></th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-procesoSituacion let-editing="editing" let-index="rowIndex">
                    <tr [pEditableRow]="procesoSituacion" [formGroupName]="index">
                        <td style="width:15%">
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <p-dropdown [options]="procesos" 
                                                appendTo="body"
                                                [filter]="true"
                                                filterBy="tippro"
                                                optionLabel="tippro"
                                                optionValue="tippro"
                                                formControlName="procTippro"
                                                #dropdownElement
                                                (onChange)="procesoSelectChange($event, index)"
                                                placeholder="Seleccione el proceso">
                                    </p-dropdown>
                                    <span class="form-text text-danger" *ngIf="campoInvalid(procesoSituacion.controls['procTippro'])">
                                        <span *ngIf="procesoSituacion.controls['procTippro']?.errors?.required"> 
                                            El código es obligatorio. 
                                        </span>
                                        <div *ngIf="procesoSituacion.controls['procTippro']?.errors?.maxlength"> 
                                            El código es de longitud máxima de 2 dígitos. 
                                        </div>
                                    </span>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ procesoSituacion.getRawValue().procTippro }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td style="width:20%">
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <input type="text"
                                           pInputText
                                           [value]="procesoSituacion.getRawValue().procesoString"
                                           [disabled]="true"/>
                                </ng-template>
                                <ng-template pTemplate="output">
                                    {{ procesoSituacion.getRawValue().procesoString }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td style="width:15%">
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <div *ngIf="!isEdit">
                                        <p-dropdown [options]="subProcesos" 
                                                    appendTo="body"
                                                    [filter]="true"
                                                    filterBy="value"
                                                    optionLabel="dessub"
                                                    optionValue="subpro"
                                                    formControlName="tipsub"
                                                    placeholder="Seleccione el sub proceso">
                                        </p-dropdown>
                                        <span class="form-text text-danger" *ngIf="campoInvalid(procesoSituacion.controls['tipsub'])">
                                            <span *ngIf="procesoSituacion.controls['tipsub']?.errors?.required"> 
                                                El Subproceso es obligatorio. 
                                            </span>
                                            <div *ngIf="procesoSituacion.controls['tipsub']?.errors?.pattern"> 
                                                El Subproceso es de longitud de 1 dígito, formato numérico. 
                                            </div>
                                        </span>
                                    </div> 

                                    <div *ngIf="isEdit">
                                        <input type="text"
                                               pInputText
                                               [value]="procesoSituacion.getRawValue().tipsub"
                                               [disabled]="true"/>
                                    </div>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ procesoSituacion.getRawValue().tipsub }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td style="width:15%">
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <input pInputText type="text" formControlName="dialim">
                                    <span class="form-text text-danger" *ngIf="campoInvalid(procesoSituacion.controls['dialim'])">
                                        <span *ngIf="procesoSituacion.controls['dialim']?.errors?.required"> 
                                            El campo día es obligatorio. 
                                        </span>
                                        <div *ngIf="procesoSituacion.controls['dialim']?.errors?.pattern"> 
                                            El campo día es de longitud máxima de 3 dígitos, formato numérico. 
                                        </div>
                                    </span>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ procesoSituacion.getRawValue().dialim }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td  style="width:15%">
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <p-dropdown [options]="noSuspender" 
                                                appendTo="body"
                                                class="w-full"
                                                formControlName="susvac"
                                                optionLabel="descripcion"
                                                optionValue="susvac">
                                    </p-dropdown>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ procesoSituacion.getRawValue().susvac == 0 ? 'No aplica' :
                                        procesoSituacion.getRawValue().susvac == 1 ? 'Salida' : 'Regreso' }}   
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td class="text-center"  style="width:20%">
                            <button *ngIf="!editing" 
                                    pButton
                                    pInitEditableRow 
                                    icon="pi pi-pencil"
                                    class="p-button-rounded p-button-text"
                                    pTooltip="Editar"
                                    tooltipPosition="bottom"
                                    (click)="onRowEditInit(procesoSituacion);"
                                    [disabled]="isEdit || isAddNewRow">
                            </button>
                            <button *ngIf="!editing" 
                                    pButton
                                    icon="pi pi-trash"
                                    class="p-button-rounded p-button-text"
                                    pTooltip="Eliminar"
                                    tooltipPosition="bottom"
                                    (click)="onRowDelete(procesoSituacion.getRawValue())"
                                    [disabled]="isEdit || isAddNewRow">
                            </button>
                            <button *ngIf="editing" 
                                    pButton
                                    pSaveEditableRow 
                                    icon="pi pi-save"
                                    class="p-button-rounded p-button-text p-button-success mr-2"
                                    pTooltip="Guardar"
                                    tooltipPosition="bottom"
                                    (click)="onRowEditSave(procesoSituacion.getRawValue())"
                                    [disabled]="procesoSituacion.status == 'INVALID'">
                            </button>
                            <button *ngIf="editing" 
                                    pButton
                                    pCancelEditableRow 
                                    icon="pi pi-times"
                                    class="p-button-rounded p-button-text p-button-danger"
                                    pTooltip="Cancelar"
                                    tooltipPosition="bottom"
                                    (click)="onRowEditCancel(procesoSituacion, index)">
                            </button>
                        </td>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="emptymessage" let-columns>
                    <tr>
                        <td [attr.colspan]="columns.length + 1">
                            <div class="div-center">
                                <div>
                                    <div class="div-round"></div>
                                    <h5 class="no-data-message-1">Sin datos para mostrar</h5>
                                </div>
                            </div>
                        </td>
                    </tr>
                </ng-template>

            </p-table>

        </div>
    </form>

</div>
