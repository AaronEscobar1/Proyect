<div class="mt-3">

    <form [formGroup]="form">
        <div formArrayName="programasDepositos">
            
            <p-table [value]="programasDepositosFormArray.controls" [columns]="columns" #dt
                     (sortFunction)="customSort($event)" [customSort]="true"
                     dataKey="controls.idTableTemporal.value" editMode="row"
                     [paginator]="true" [rows]="rows"
                     styleClass="p-datatable-scrollable" responsiveLayout="scroll"
                     [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} registros de {totalRecords} entradas." [rowsPerPageOptions]="[5, 10, 25, 50]">
            
                <ng-template pTemplate="caption">
                    <div class="grid flex-row-reverse">
                        <div class="col-12 md:col-4 lg:col-3">
                            <button pButton
                                    label="Agregar programa" 
                                    class="p-button-secondary"
                                    (click)="addNewRow()"
                                    [disabled]="isEdit || isAddNewRow">
                            </button>
                        </div>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th *ngFor="let col of columns" [pSortableColumn]="col.field">
                            {{ col.header }}
                            <p-sortIcon [field]="col.field"></p-sortIcon>
                        </th>
                        <th style="width:8rem"></th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-programa let-editing="editing" let-index="rowIndex">
                    <tr [pEditableRow]="programa" [formGroupName]="index">
                        <td>
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <input pInputText type="text" formControlName="nombrePgm">
                                    <span class="form-text text-danger" *ngIf="campoInvalid(programa.controls['nombrePgm'])">
                                        <span *ngIf="programa.controls['nombrePgm']?.errors?.required"> 
                                            El nombre es obligatorio. 
                                        </span>
                                        <div *ngIf="programa.controls['nombrePgm']?.errors?.maxlength"> 
                                            El nombre es de longitud máxima de 10 dígitos.
                                        </div>
                                    </span>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ programa.getRawValue().nombrePgm }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td>
                            <p-cellEditor>
                                <ng-template pTemplate="input" formGroupName="nmTipoProgramaTb">
                                    <p-dropdown [options]="tiposProgramas" 
                                                appendTo="body"
                                                class="w-full"
                                                formControlName="tippgm"
                                                optionLabel="descripcion"
                                                optionValue="tippgm">
                                    </p-dropdown>
                                    <span class="form-text text-danger" *ngIf="programa.controls['nmTipoProgramaTb'].touched && programa.controls['nmTipoProgramaTb'].status == 'INVALID'">
                                        <span *ngIf="programa.controls['nmTipoProgramaTb'].controls['tippgm']?.errors?.required"> 
                                            El tipo es obligatorio. 
                                        </span>
                                    </span>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ programa.getRawValue().nmTipoProgramaTb.descripcion }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td>
                            <p-cellEditor>
                                <ng-template pTemplate="input">
                                    <input pInputText type="text" formControlName="descrip">
                                    <span class="form-text text-danger" *ngIf="campoInvalid(programa.controls['descrip'])">
                                        <div *ngIf="programa.controls['descrip']?.errors?.maxlength"> 
                                            La descripción es de longitud máxima de 256 dígitos.
                                        </div>
                                    </span>
                                </ng-template>

                                <ng-template pTemplate="output">
                                    {{ programa.getRawValue().descrip }}
                                </ng-template>
                            </p-cellEditor>
                        </td>
                        <td class="text-center">
                            <button *ngIf="!editing" 
                                    pButton
                                    pInitEditableRow 
                                    icon="pi pi-pencil"
                                    class="p-button-rounded p-button-text"
                                    pTooltip="Editar"
                                    tooltipPosition="bottom"
                                    (click)="onRowEditInit(programa);"
                                    [disabled]="isEdit || isAddNewRow">
                            </button>
                            <button *ngIf="!editing" 
                                    pButton
                                    icon="pi pi-trash"
                                    class="p-button-rounded p-button-text"
                                    pTooltip="Eliminar"
                                    tooltipPosition="bottom"
                                    (click)="onRowDelete(programa.getRawValue())"
                                    [disabled]="isEdit || isAddNewRow">
                            </button>
                            <button *ngIf="editing" 
                                    pButton
                                    pSaveEditableRow 
                                    icon="pi pi-save"
                                    class="p-button-rounded p-button-text p-button-success mr-2"
                                    pTooltip="Guardar"
                                    tooltipPosition="bottom"
                                    (click)="onRowEditSave(programa.getRawValue())"
                                    [disabled]="programa.status == 'INVALID'">
                            </button>
                            <!--  -->
                            <button *ngIf="editing" 
                                    pButton
                                    pCancelEditableRow 
                                    icon="pi pi-times"
                                    class="p-button-rounded p-button-text p-button-danger"
                                    pTooltip="Cancelar"
                                    tooltipPosition="bottom"
                                    (click)="onRowEditCancel(programa, index)">
                            </button>
                        </td>
                    </tr>
                </ng-template>
                    
                <ng-template pTemplate="emptymessage" let-columns>
                    <tr>
                        <td [attr.colspan]="columns.length + 1">
                            <div class="div-center">
                                <div>
                                    <div class="div-round"></div>
                                    <h5 class="no-data-message-1">Sin datos para mostrar</h5>
                                </div>
                            </div>
                        </td>
                    </tr>
                </ng-template>
    
            </p-table>

        </div>
    </form>

</div>